# node基础

[TOC]

### 内存管理

#### 进程所需的内存

在通常情况下，64位系统中node进程默认拥有1.4GB内存，而32位的话拥有0.7GB内存。如果遇上处理大对象的时候，可以利用在堆外的Buffer来进行存储操作，这是在C++层面上的事情。

#### 垃圾回收机制

如何判断对象存活：图的可达性分析，从变量引用开始，进行图的遍历，标记出存活的对象

##### 新生代

- 将内存对分，分成使用的一半和未使用的一半，然后使用scavenge算法，每次进行回收的时候将存活的对象复制到另外一半。然后调换角色。
- 升级，当对象经历过一次垃圾回收或者此时的to区域占用25%的时候，那么认为该对象符合老年代对象的要求，会进行存放到老年代。

##### 老年代

- 标记清除、标记整理。
- 增量式操作：根查找、标记阶段、清除阶段

####  事件循环

Node环境下的事件循环和浏览器的事件循环有所不同，分为6个阶段

1. timer：在这个阶段执行setTimeout和setInterval的事件回调。有个timer队列
2. IO Callback：在这个阶段执行IO回调函数的阶段
3. 内部事件回调：执行node内部事件
4. poll：轮询阶段，检索有没有IO事件，如果有IO事件的话，进行执行
5. check：setImmediate事件回调函数
6. IO close：IO关闭的回调函数，比如Socket的close事件回调

并且node每个事件循环都会有个微观队列

### 洋葱模型

koa2的洋葱模型是处理中间件策略。它将整个系统看作一个洋葱，具有一层层结构，然后一个请求进来，首先从外而内执行中间件，然后返回的时候会从内而外执行。所以中间件的调用是之字形调用。

每个中间件的生命周期为：

- 前期执行
- 下一个中间件执行
- 后期执行

洋葱模型的好处：

- 代码能够放置在一起，如设置编码代码，请求进来进行改编码，请求发还回去对数据进行改编码，都可以在一个中间件中完成。
- 日志打印：出入口日志打印，无需再业务层进行代码加入，只需要统一再中间件中进行处理。