[TOC]

### HTTP

##### 概念

- http是无状态、无连接的、基于TCP的应用层超文本报文协议，

##### 请求过程

- 首先确定请求的url是不是一个域名，如果是一个域名，会去DNS系统查询对应的ip地址
- TCP通过拿到的url进行三次握手连接
- 连接完毕后http将url、请求版本等信息请求封装头部和将数据封装成报文体，将其转为字节流让tcp进行封装。
- 服务端拿到所有数据后，转为http协议。运行对应的服务，返回数据
- 客户端拿到数据后，拿到http头部，查看connection字段，如果是close 的话，关闭tcp请求，如果connection是keep-alive的话，则会保留一段时间。

### HTTP请求的Keep-Alive

1.HTTP Keep-Alive

##### 1）简介

 	在HTTP1.0之前，每个HTTP请求都需要使用一个TCP请求，这样很消耗资源。在HTTP1.0之后，在头部中使用connnection：keep-alive字段，即可保持存活。同时，返回的请求也需要有

##### 2）字段

- `Keep-Alive`：有`max`和`timeout`，分别代表着最大连接数和超时时间。
- `Connection`：有`close`代表关闭，和`Keep-Alive`代表保持连接。

##### 2.TCP Keep-Alive

​	`TCP`的`Keep-Alive`表示保持存活，因为`TCP`是不会知道引用层的内容的，只能由应用层来进行打开。而有这个字段的话，在`TCP`中会不断发送心跳包，如果对方已经关闭了，就不会有任何响应。这样就会关闭TCP连接。

### 2.HTTPS

#### 默认端口

HTTPS的默认端口是443

#### 与HTTP的区别

HTTPS是为了解决HTTP存在的安全性问题，所以我们先讲一下HTTP存在的安全问题。

1. 明文传输，这是最大的问题
2. 无法验证服务器的身份，因此可能被伪装。
3. 无法检验传输内容是否被篡改过

接下来讲一下HTTPS针对于上述存在的问题的解决方式：

HTTPS协议在运输层和应用层之间有一层加密协议层，由SSL或者TLS组成，这一层的功能有三个：

- 加密传输：将明文加密成密文
- 校验机制：检验传输的数据是否被篡改过
- 身份验证：配置验证证书

##### 1.加密

HTTPS的加密采用非对称加密匹配堆成加密的方式。

- 非对称加密：在开始进行加密的操作的时候，先进行对称加密秘钥的协商。具体流程是首先服务端选择一种非对称加密算法，将公钥发送到客户端（自己存放私钥）。客户端首先生成随机字符串，用公钥进行加密，然后传输到服务端，服务端通过私钥进行解密，得到的结果就是作为对称加密的秘钥。
- 对称加密：在传输数据的时候通过协商得到的秘钥进行加密传输。

特点：

- 秘钥动态生成，可以大大减少被破解的可能。

##### 2.身份验证

HTTPS需要进行配置身份验证，由比较高安全性的中间商进行颁发证书。具体身份认证流程如下：

通常使用Web的时候使用单向验证的方式，那么就讲一下单向验证的整体流程：

1. 浏览器发送验证的SSL版本等信息
2. 服务端返回SSL证书
3. 浏览器请求CA进行验证是否过期等等。
4. 发送可支持的秘钥方式给服务端，服务端选择安全性等级最高的算法给客户端，并且携带公钥
5. 客户端随机生成字符串使用公钥进行加密，传回服务端
6. 服务端使用私钥进行解密，这就是传输数据的对称加密算法秘钥。接下来就是加密的流程。

##### 3.校验传输数据是否被篡改

虽然有使用 HTTP 协议确定报文完整性的方法，但事实上并不便捷、可靠。其中常用的是 **MD5** 和 **SHA-1** 等**散列值校验**的方法，以及用来确认文件的**数字签名**方法。

提供文件下载服务的 Web 网站也会提供相应的以 PGP（Pretty Good Privacy，完美隐私）创建的数字签名及 MD5 算法生成的散列值。**PGP 是用来证明创建文件的数字签名，MD5 是由单向函数生成的散列值**。不论使用哪一种方法，都需要操纵客户端的用户本人亲自检查验证下载的文件是否就是原来服务器上的文件。浏览器无法自动帮用户检查。

数字签名：使用**私钥**进行加密，使用公钥进行**解密**。

##### 4.HTTPS的四次握手

![img](../../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/PersonNote/%E9%9D%A2%E7%BB%8F/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9C%BA%E5%88%B6/images/2718191-e2a6b0a921c93075.webp)

1. 浏览器（客户端）随机数字，发送到服务端，并且发送ssl/tls版本等信息（第一次握手）
2. 服务端通过ssl/tls等信息，选择安全度最高的算法， 并且产生随机数。最后连同公钥发送给客户端（第二次握手）
3. 客户端接收到数字证书等信息，去验证是否过期。然后生产成随机字符串，然后将字符串通过公钥加密一起发送到服务端。
4. 最后客户端通过字符串+客户端随机数+服务端随机数根据加密算法进行加密。服务端也是这么加密。这样就要有了对称加密的秘钥。

###### 问：https四次握手就不需要TCP三次握手了嘛？

不，还是需要的，TCP三次握手的目的是保证打开服务器端口，从而进行传输数据。而https是在应用层面的握手。还是需要先进行TCP握手才能传输数据。

### HTTP1.1和HTTP2的比较

#### 1.多个请求共享同一个TCP连接机制

- HTTP1.1中多个请求共享TCP连接的话，是串行共享的，也就是前面的请求没有结束，后面的并不会开始
- HTTP2是采用并行策略，实现多路复用，然后根据不同的包的头部进行拼装，这样不会出现前面阻塞后面就不会开始的情况。**同个域名只需要一个TCP连接，而且不同的HTTP请求会有优先级别**

#### 2.数据流格式

- HTTP1.1的数据流是以文本为数据流的形式，以特定的符号进行分割不同的内容。
- HTTP2则是采用二进制分帧形式，消息由一个帧或者多个帧组成，服务器解析起来更快速。

#### 3.是否支持服务器主动推送

- HTTP1.1不支持
- HTTP2支持

#### 4.头部压缩

- HTTP1.1每次请求都会带所有的头部
- HTTP2每次请求的头部只会发送那些更改了的头部，并且会根据算法进行压缩头部。

### TCP

##### 1.特点：

- 面向连接
- 面向字节流
- 具有拥塞控制
- 提供可靠服务

##### 2.拥塞控制：

- 慢开始：拥塞窗口一开始设置成1，然后发送成功就会翻倍，成指数增长

- 拥塞避免：当拥塞窗口大于慢开始门限的时候，会变成线性增长，使用拥塞避免

  如果某一个包的定时器发生超时，那么此时会将慢开始门限设为拥塞窗口的一半，并且拥塞窗口设为1开始，重新开始使用慢开始算法。

- 快重传：在某个包的定时器发生超时前，如果对于同一报文的确认ack收到3个，说明仅仅是这个包丢失了，那么使用快重传算法，发送对应序号的数据包。并且执行快恢复算法。

- 快恢复：慢开始门限与拥塞控制窗口设为拥塞窗口的一半，并且使用拥塞避免。

**[注意]**：

- 无论是慢开始，还是拥塞避免阶段，遇到超时的情况下，都是慢开始门限设为拥塞窗口的一半，拥塞窗口设为1，然后慢开始
- 遇到三个相同的ACK（超时之前），则将拥塞窗口设为原来的一半，慢开始门限也是这个值，然后执行拥塞控制。

##### 3.数据包的字段

- SYN：同步位，若是为1的情况下，则不能携带数据，但是要消耗一个序号，这是建立请求的数据包。在三次握手中的第一二次中携带。并且回答的时候需要使用ACK序列号，即SYN-ACK应答机制表示验证包是回应包。

  作用：判断发送方到接收方的通信是不会出错的。所以需要用ACK来应答

- seq：本次序列号

- ack：期待接收的下次序列号

##### 4.停止等待协议

- 发送一个数据报，然后等待对方收到并且发回信息才发送下一个数据报
- 收到相同的数据包，会丢掉并返回该包的确认信息。

##### 5.连续ARQ协议

- 提高信道利用率，发送方维持一个窗口，可以一次性发送多个包，然后接收方对连续累计收到的最后一个包发送确认信息。
- 缺点，接收方没有类似窗口机制，如果中间的包丢失了的话，那么后面就算到达很多个包，也要重新发送。

##### 6.滑动窗口协议

- TCP利用滑动窗口来进行流量控制
- 发送方通过滑动窗口的大小来确定同一时间内最大能发送数据包的数量，这样能够进行流量控制，当窗口为0的时候，不会进行发送数据。
- 接收方可以通过控制窗口大小来控制发送方的窗口大小，从而来实现控制发送速率。**也就是说，发送窗口是由拥塞窗口和接收窗口的最小值决定的**

### TCP提高网络利用率

##### 1.发送方发送字节数较少

每次只发送一个字节，但是要携带很长的头部。

**Nagle算法**

基本定义：**任意时刻，最多只能有一个未被确认的小段**，即会将小于MSS的数据包结合在一起。**当到达的数据已达到发送窗口大小的一半或者达到报文段的最大长度的时候，就立即发送一个报文段。**

算法规则:

- 包长度到达MSS，最大长度包，即可发送
- 包含有FIN，则进行发送
- TCP_NODELAY，直接发送
- 其他情况下都是延迟发送

**捎带应答**

- 在一个TCP数据包中既发送数据也发送应答，这样节省了开始。

##### 2.糊涂窗口综合症

接收方接收缓冲数据速率比较慢，比如每次只收1字节的数据，返回一个字节的数据确认。导致发送窗口变成1，然后以后每次都是发送1字节数据携带上40字节的头部，这样会使得网络利用率很低。

解决办法是延迟确认应答。

**延迟确认应答**

接收方接收到数据的时候，不会立即确认应答，而是达到以下条件的时候才去确认应答：

- 收到两倍最大报文段的数据的时候
- 超过0.5s的时候
- TCP中，大多数是两个包一起应答

### UDP

- 提供尽可能的，不保证可靠的传输
- 面向报文体，即应用层下来的是UDP报文
- 不存在拥塞控制
- 头部比较小
- 面向无连接

#### UDP如何提供可靠服务？

- 具有超时重传机制
- 发送的报文具有序号，这样就能够保证给到的报文正确组装
- 具有应答机制：即seq和ack前者是当前序列号，后者是期望收到的序列号
- 具有滑动窗口等

### 常见问题集

##### 1.IP地址分为几类，他们的区别是什么？

IP分为5类地址

ABC是单播地址，D是多播地址，E保留今后使用。

ABC一次网络号长度递增一字节。网络号越短，主机就越多。

子网掩码的作用是为了获得网络号和主机号，从而判断两个地址是否在同一网络上。

##### 2.简单说一下你了解的端口以及对应的服务

- 443：https
- 80：http
- 21

##### 3.为什么要三次握手而不是两次

- 第三次握手的目的是为了防止失效的连接到达目的地，让目的地以为建立连接。

##### 4.TIME_WAIT的目的|为什么第四次挥手后，请求方要等待2MSL

- 为了防止最后的报文在网络中消失
- 防止失效的报文重新到达，即在2MSL中，本次连接的所有报文能够消失在网络上，不会对下次连接造成影响。