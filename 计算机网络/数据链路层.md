# 数据链路层

### 数据链路层信道类型

- 点对点信道：一对一点对点通信（PPP协议是点对点信道类型）
- 广播信道：一对多通信

****

### 点对点信道的数据链路层

链路和数据链路并不是一回事，链路指的是相邻结点之间的物理连线，而数据链路除了物理连线之外还有一些通信协议等等。

数据链路层把网络层传下来的数据构成帧发送到链路上，以及把接收到的帧上交到网络层。在互联网中，数据单元就是IP数据报。点对点数据链路层进行通信的时候的主要步骤如下：

- A节点在接收到网络层交下来的IP数据报添加首部和尾部封装成帧
- 节点A把封装好的帧发送到B的数据链路层
- B接收到的帧无差错，则会提取IP数据报上交到网络层，否则丢弃

****

### PPP协议

PPP协议数据的组成：

PPP协议将数据封装了帧，每一帧都有三个部分：头部、数据部分、尾部

- 头部：由十六进制的7E开头，还有一个占用位，想着以后用的，但是现在还没有定义的，是FF还有03。这些都是没有定义的。最后还有一个2字节的协议，代表着这个数据报的传输协议。
- 数据部分：可变长的数据部分，最大有1500字节
- 尾部：有一个fcs和一个标志符7E。

标志着数据报的开始和结尾的是7E，那么很多人会问，如果在数据部分出现了7E这个数据怎么办，下面有两种方式来解决这个 问题：

1. 字节填充：如果出现了7E，那么用7D和5D进行代替7E。如果在字段中除夕拿了7D，那么将7D转为7D+5D。（以上都是十六进制数）
2. 零比特填充：发送端一旦出现5个1，后面必定会添加一个0，然后在接收端如果出现5个1，后面必定去掉0。

以上两种办法也是实现透明传输的方法。透明传输即对于上一面一层是透明的，不会因为数据而发生变化。

##### 差错检测：

- 循环冗余检测法CRC：
  1. 首先，传输双方确定一个除数P，这个P的位数为n+1,
  2. 将传输的二进制帧进行n位模二乘法，即在帧后面+n个0
  3. 进行模二除法运算
  4. 得到余数加到帧后面
  5. 接收方接收完毕后进行P的模二运算，如果为0，则认为准确。

****

### 使用广播信道的数据链路层

特点：1对多。

### 局域网的数据链路层：

局域网的特点：由一个单位所有，里面的地理范围和节点是有限的。

优点：

- 具有广播功能。可以享受到网络上的所有资源
- 灵活性
- 可靠性、生存性、可用性

##### 拓扑结构：

- 星形结构：
- 环形结构：
- 总线型结构：现在大多用总线型结构。

##### 信道划分：

- 静态信道划分：频分复用、时分复用、码分复用、波分复用。
- 动态信道划分：随机接入、受控接入。

##### 适配器作用：

​	存有硬件固有的地址MAC地址，这个地址永久存储在这个适配器中。适配器在接收帧和处理帧的过程中并不会经过cpu的计算，即不会通知cpu进行。

****

### CSMA/CD协议

#### 使用总线型拓扑结构

##### 总线型拓扑结构如何实现1对1通信

​	总线型拓扑结构中发送数据的时候，所有的主机都会接收到数据。但是只有在rom中保存的硬件地址和数据传输的硬件地址相一致的时候才会接受。

##### 以太网采取数据传输措施

1. 面向无连接传输，即双方进行传输数据并不需要建立连接，数据到了就接受。尽可能的最大交付数据，提供不可靠的传输。只是对数据进行接收，控制还是由上级进行控制。同一个时间点只能由一个主机进行传输数据，采用CSMA/CD协议，即载波监控多接入/碰撞检测（多点接入：即总线型拓扑结构，载波监控：检测是否正在传输数据；碰撞检测：边传输边检测）
2. 采用曼彻斯特编码进行传输数据。

特别记住：电磁波在1km的电缆中进行传输的时延为5us。

使用CSMA/CD协议进行传输的时候，会边进行传输边检测是否碰撞。会检测碰撞，碰撞的时候会停止发送数据。

![](.\images\1.png)

##### 截断二进制指数退避算法

1. 协议规定基本退避时间为征用期2τ，具体时间为51.2us，对于10Mbit/s以太网则可发送512bit数据，则称为512比特时间。（就是发送到发送数据完毕的那一刻，接收端刚好接收到数据）

2. 从离散整数集合0到2的k次方-1中随机去除一个数字，记为r，重传应退后的时间就是r倍争用期，上面的参数按照下面的计算为

   ​						k=min[重传次数，10]

3. 当传输16次的时候还不能传输成功的时候，会向上级报告并且停止传输。

算法时间：截断二进制指数退避算法可以使重传的平均时间岁重传次数的增加而增大。

总结整个过程：数据链路层采用CSMA/CD协议进行传输的时候，会边传输边进行碰撞检测。在发送数据的时候收到其他点进行传输的时候，会停止传输。停止后并不会在检测到空闲就立即传输，而是会退避一段时间，这个时间的**单位**就是数据单程端到端传输时间的τ的2倍：2τ。并且倍数是在离散的整数集合中进行获取一个数字，这个整数集合为

​							{0, 1, 2, 4, .... 2(k平方) - 1}

其中k在传输次数少于10的时候代表重传次数，大于时的时候则是10.即

​							k=min[重传次数，10]

这样有效地避免再次碰撞，但是如果k大于16的时候，则认为传输失败，会向上级进行汇报。

##### 碰撞强化概念

​	发送数据的站一旦发现发生了碰撞，除了立即停止发送数据，还要发一些32字节或者48字节的无效帧告诉大家发生碰撞了。

#### 使用集线器的星形拓扑结构

1. 集线器的特点：

   - 从表面上看，集线器是一个星型拓扑结构，实际上在逻辑上还是属于总线型拓扑结构。并且还是使用CSMA/CD协议
   - 一个集线器有多个接口
   - 集线器工作在物理层。

2. 以太网的信道利用率。

   首先看一下以太网信道都在干什么？

   ![](.\images\2.png)

   以太网信道分为发生碰撞期还有非发生碰撞期。所以导致以太网道利用率没办法达到100%；

   信道利用率公式为

   ​								a=τ/T0

   其中τ是端到端的传输时延、T0是帧发送时间（从发送开始到发送结束）。说明当速率一定的时候，以太网连线不能太长（影响τ）还有帧长不能太短。

   **极限信道利用率**：假设一下理想化的情况，假设以太网上发送的数据不会发生碰撞，并且能有有效利用网络传输资源，即总线一有空就发送数据。这样发送一帧占用的时间为t=τ+T0，则极限信道利用率为

   ​								S(max)=T0/(τ+T0)=1/(a+1)

   说明只有a足够小的时候才有可能获得最大的信道利用率。

#### 以太网的MAC层

​	MAC地址又称硬件地址，是在适配器生产的时候在rom写入的一个地址，每个适配器的地址都不一致。其实MAC地址就是这个适配器的标号而且。

**MAC帧格式**：

![](.\images\3.png)

由目的地址、源地址、类型、ip数据报和FCS组成（CRC检测）。这个是MAC帧的组成，但是在MAC帧之前还有一个8字节的标识符，组成如下：1010交替的7字节的调整时钟帧，这个叫做同步码。作用就是让接收端的适配器在接收MAC帧的时候调整好时钟频率。然后最后一个字节就是帧开始的界定符。

****

### 扩展的以太网

#### 从物理层扩展以太网

​	很简单，使用光纤

#### 从数据链路层扩展以太网

- 网桥
- 交换式集线器（第二层交换机或以太网交换机）

以太网交换机特点：

​	以太网交换机实际上是多接口的网桥。传统的共享以太网而言，如果有10Mbit/s的网络，10个用户使用平均下来每个用户有1Mbit/s的网络，但是交换机可以实现每个用户都有10Mbit/s的网络。这是因为以太网交互在通信的时候是独占式通信而不是共享传输媒介的带宽。

内部有一个地址表是通过自学习从而建立起来的，自学习的规则如下：

1. 访问的时候先从路由表查询是否有目标MAC层的接口，如果有，直接使用，如果没有，进行广播。
2. 进行广播后，会带目的MAC地址和自身的MAC地址进行广播（局域网广播），收到广播的接口会进行判断MAC目标地址是否与自身MAC地址相同。如果相同的话，会回复自身接口。并且存于路由表中。

