# NodeJS中的异步IO

####  事件循环

1. 在进程启动的时候，Node便会创建一个无限的循环，这个循环来查看是否有事件待处理，如果有，则取出事件及其相关的回调函数进行处理。然后进入下一个循环，如果没有事件需要处理时候，退出进程。

####  观察者

1. 观察者相当于监听器，来监听有什么事件产生，将其分类，然后把它交给事件循环进行处理。

#### 请求对象

1. Node中的异步I/O调用到完成中间发生的事情：如以下代码：

```JavaScript
fs.open = function(path, flags, mode, callback) {
    //..
    binding.open(pathModule._makelong(path),
                	stringToFlags(flags),
                	mode,
                	callback);
};
```

fs.open的作用是指定路径和参数去打开一个文件，从而得到文件的描述符。而代码的执行的层次路径为以下：

JavaScript调用核心模块、核心模块调用C++内建模块、C++通过内建模块进行系统调用。即

**fs.js->node_file.cc->平台判断->执行。**

#### 执行回调

1. 组装好请求对象后 ，送入线程池中进行执行，这是程序的第一步，回调通知是这个程序的第二步。 调用IO操作对象先在线程池中找到线程，然后进行IO操作，操作完毕后会通知IOCP（win10环境下）完成回调，交给相应的观察者。

#### 异步IO小结

​	实现异步IO过程描述中，关键词有单线程、事件循环、IO线程池、观察者。单线程和线程池看起来是个悖论，其中在NodeJS中，只有JS是单线程的，Node自身是多线程的。所以除了用户自身的业务代码是无法并行之外，其他所有IO是可以并行的。

#### 非阻塞IO的异步AP I

1. 定时器（setTimeout）：setTimeout可以设置异步操作，但是设置后并不会在线程池中，而是插入到定时器观察者内部的一个红黑树中，每次执行时候从该红黑树中迭代取出定时器对象，检查是否超过规定时间，如果超过，就形成一个事件，它的回调事件将立刻执行。但是，它并不会很精准，如果设置10毫秒后执行，但是刚好在九毫秒的时候执行一个需要5毫秒的代码块，则会在第14毫秒的时候执行。
2. process.nextTick：这个方法是立即调用异步函数，类似于setTimeout（fn, 0）。但是是轻便版本的setTimeout，前面说过，每次调用setTimeout的时候都会从红黑树中进行迭代查询，所以会比较花时间。而nextTick则不需要。
3. setImmediate：这个方法也是立即调用异步回调函数，这个方法和nextTick的区别是先后顺序的区别，在每次事件循环时候，nextTick总是会比setImmediate早一点执行，并且setImmediate每次事件循环时候只能执行一个，即如果有三个连续的setImmediate，会一次执行于三个事件循环中。这是因为nextTick的实现列表是一个顺序表存储结构，而setImmediate则是链式存储结构。

